<!doctype html>
<html lang="en">
<head>
  <!-- ...existing code... -->
  <style>
    /* ...existing code... */
    #mobile-menu {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transition: max-height 250ms ease-out, 
                    opacity 200ms ease-out,
                    visibility 0s linear 250ms;
    }
    #mobile-menu.expanded {
        max-height: 100vh;
        opacity: 1;
        visibility: visible;
        transition: max-height 250ms ease-in,
                    opacity 200ms ease-in,
                    visibility 0s linear 0s;
    }

    /* Slight accessibility helpers so hidden state is clear in CSS too */
    #mobile-menu[aria-hidden="true"] { pointer-events: none; }
    #mobile-menu[aria-hidden="false"] { pointer-events: auto; }

    /* Minor utility so the rotating icon animates */
    .transform { transform-origin: center; }

    /* ADDED: layer menu over navbar and prevent background scroll */
    #mobile-menu { position: absolute; top: 100%; left: 0; right: 0; z-index: 1200; }
    body.no-scroll { overflow: hidden; }
  </style>
</head>
<body class="font-sans antialiased text-gray-800">
  <!-- ...existing code... -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            // Cache DOM queries
            const elements = {
                button: document.getElementById('mobile-menu-button'),
                menu: document.getElementById('mobile-menu'),
                icon: document.getElementById('menu-icon'),
                desktopLinks: new Set(document.querySelectorAll('[id$="-link"]')),
                mobileLinks: new Set(document.querySelectorAll('[id$="-link-mobile"]'))
            };

            if (!elements.button || !elements.menu) {
                throw new Error('Required navigation elements not found');
            }

            const TRANSITION_MS = 250;
            let hideTimeout = null;

            // ADDED: define setActiveLink to avoid ReferenceError
            const setActiveLink = () => {
              const page = (window.location.pathname.split('/').pop() || 'index.html').replace('.html','');
              const desktop = document.getElementById(`${page}-link`);
              const mobile  = document.getElementById(`${page}-link-mobile`);
              desktop && desktop.classList.add('text-teal-600','font-medium');
              mobile  && mobile.classList.add('text-teal-600','font-medium');
            };

            const toggleMenu = (show) => {
                try {
                    const { menu, button, icon } = elements;

                    if (hideTimeout) {
                        clearTimeout(hideTimeout);
                        hideTimeout = null;
                    }

                    menu.classList.toggle('expanded', show);
                    icon?.classList.toggle('rotate-90', show);
                    button.setAttribute('aria-expanded', String(show));
                    menu.setAttribute('aria-hidden', String(!show));
                    // ADDED: lock/unlock background scroll
                    document.body.classList.toggle('no-scroll', show);

                    if (!show) {
                        hideTimeout = setTimeout(() => { hideTimeout = null; }, TRANSITION_MS);
                    }
                } catch (error) {
                    console.error('Error toggling menu:', error);
                }
            };

            const handleDocumentClick = (e) => {
                const { button, menu } = elements;
                if (!button.contains(e.target) && !menu.contains(e.target)) {
                    toggleMenu(false);
                }
            };

            const init = () => {
                elements.button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isExpanded = elements.menu.classList.contains('expanded');
                    toggleMenu(!isExpanded);
                });

                document.addEventListener('click', handleDocumentClick);

                // Initialize state
                toggleMenu(false);
                setActiveLink(); // now defined
            };

            init();

        } catch (error) {
            console.error('Navigation initialization failed:', error);
        }
    });
  </script>
  <!-- ...existing code... -->
</body>
</html>